<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Transcriptie - HEIDENHAIN</title>
    <!-- Production: Use the local build of Tailwind CSS -->
    <!-- Development: Use the CDN with development settings -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Disable Tailwind CSS CDN warning
        window.tailwind = { config: { theme: { extend: {} } } };
    </script>
    
    <style>
        /* HEIDENHAIN Kleuren */
        :root {
            --heidenhain-dark: #373737;
            --heidenhain-darker: #2c2c2c;
            --heidenhain-accent: #b3b441;
            --heidenhain-text: #ffffff;
        }

        /* Toepassen van de kleuren */
        body {
            background-color: var(--heidenhain-dark);
            color: var(--heidenhain-text);
            font-family: sans-serif;
        }
        .bg-hh-dark { background-color: var(--heidenhain-dark); }
        .bg-hh-darker { background-color: var(--heidenhain-darker); }
        .bg-hh-accent { background-color: var(--heidenhain-accent); }
        
        /* Button styling */
        .btn-hh {
            background-color: var(--heidenhain-accent);
            color: var(--heidenhain-text);
            font-weight: bold;
            text-transform: uppercase;
            padding: 0.75rem 1.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .btn-hh:hover {
            filter: brightness(110%);
        }
        
        .file-input-hh::file-selector-button {
            background-color: var(--heidenhain-accent);
            color: var(--heidenhain-text);
            border: 0;
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            border-radius: 0.25rem;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            transition: background-color 0.2s;
        }
        .file-input-hh::file-selector-button:hover {
            filter: brightness(110%);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-hh-darker shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 50" class="h-8 w-auto">
                    <text x="0" y="30" font-family="Arial, sans-serif" font-size="24" font-weight="bold" fill="#b3b441">WHISPER</text>
                </svg>
                <span class="ml-2 text-white text-lg font-bold">API</span>
            </div>
            <h1 class="text-xl font-bold uppercase">Audio Transcriptie Tool</h1>
        </div>
        <div>
            <button id="settingsBtn" class="text-gray-300 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto bg-hh-darker rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold mb-6 text-center uppercase">Audio uploaden voor transcriptie</h2>
            
            <form id="uploadForm" class="space-y-6">
                <!-- Bestandsselectie met drag & drop -->
                <div>
                    <label class="block text-sm font-bold uppercase mb-2">
                        Selecteer audiobestand
                    </label>
                    <div id="dropZone" class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center cursor-pointer hover:border-hh-accent transition-colors">
                        <input id="audioFile" name="audioFile" type="file" class="hidden" accept="audio/*,video/*" />
                        <div class="space-y-2">
                            <div class="mx-auto w-12 h-12 bg-hh-accent/20 rounded-full flex items-center justify-center">
                                <i class="fas fa-file-audio text-hh-accent text-xl"></i>
                            </div>
                            <p class="text-sm text-gray-300">
                                <span class="text-hh-accent font-medium">Klik om te uploaden</span> of sleep een bestand hierheen
                            </p>
                            <p id="fileName" class="text-xs text-gray-400 mt-2">Ondersteunde formaten: MP3, WAV, MP4, etc. (max. 50MB)</p>
                        </div>
                    </div>
                    
                    <!-- Taalselectie -->
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="language">
                            Audiotaal:
                        </label>
                        <select id="language" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-800">
                            <option value="nl" class="text-gray-800">Nederlands</option>
                            <option value="en" class="text-gray-800">Engels</option>
                            <option value="de" class="text-gray-800">Duits</option>
                            <option value="fr" class="text-gray-800">Frans</option>
                            <option value="es" class="text-gray-800">Spaans</option>
                        </select>
                    </div>
                    
                    <!-- Voorbeeldbestanden -->
                    <div class="mt-4">
                        <p class="text-sm text-gray-400 mb-2">Of probeer een voorbeeld:</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <button type="button" class="text-left p-3 bg-hh-darker hover:bg-gray-700 rounded-lg border border-gray-700 text-sm transition-colors" onclick="loadExample('example1')">
                                <div class="font-medium text-white">Voorbeeld 1</div>
                                <div class="text-xs text-gray-400">Nederlands gesprek (15 sec)</div>
                            </button>
                            <button type="button" class="text-left p-3 bg-hh-darker hover:bg-gray-700 rounded-lg border border-gray-700 text-sm transition-colors" onclick="loadExample('example2')">
                                <div class="font-medium text-white">Voorbeeld 2</div>
                                <div class="text-xs text-gray-400">Engelse presentatie (30 sec)</div>
                            </button>
                        </div>
                    </div>
                </div>
                <button  
                    type="submit"  
                    class="w-full btn-hh"
                >
                    Upload en Transcribeer
                </button>
            </form>

            <!-- Status indicator -->
            <div id="status" class="mt-6 p-4 bg-hh-darker/80 border border-gray-700 rounded-lg hidden">
                <div class="flex items-center space-x-4">
                    <div class="w-6 h-6 border-4 border-hh-accent border-t-transparent rounded-full animate-spin"></div>
                    <div class="flex-1">
                        <p id="statusText" class="text-gray-200 font-medium">Bestand verwerken...</p>
                        <div class="w-full bg-gray-700/50 rounded-full h-2 mt-2 overflow-hidden">
                            <div id="progress" class="bg-hh-accent h-full rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Error message -->
            <div id="error" class="mt-6 hidden">
                <div class="bg-red-900/80 border-l-4 border-red-500 text-red-100 p-4 rounded-r-lg flex items-start">
                    <i class="fas fa-exclamation-triangle text-xl mr-3 mt-0.5"></i>
                    <div>
                        <p class="font-bold">Er is een fout opgetreden</p>
                        <p id="errorMessage" class="text-sm mt-1"></p>
                    </div>
                </div>
            </div>

            <!-- Result section -->
            <div id="result" class="mt-6 hidden">
                <div class="p-4 bg-hh-darker rounded-lg border border-gray-700">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                        <h3 class="text-lg font-bold text-white uppercase">Transcriptie</h3>
                        <div class="flex space-x-2 w-full sm:w-auto">
                            <button id="copyBtn" class="text-sm bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded flex items-center transition-colors">
                                <i class="far fa-copy mr-1.5"></i> Kopiëren
                            </button>
                            <a id="downloadBtn" href="#" class="text-sm bg-hh-accent hover:bg-yellow-600 text-white px-3 py-1.5 rounded flex items-center transition-colors">
                                <i class="fas fa-download mr-1.5"></i> Opslaan
                            </a>
                        </div>
                    </div>
                    <div id="transcript" class="whitespace-pre-line bg-hh-dark/50 text-gray-300 p-4 rounded-lg border border-gray-700 font-mono max-h-96 overflow-y-auto"></div>
                    
                    <div class="mt-3 text-xs text-gray-400 flex items-center">
                        <i class="fas fa-info-circle mr-1.5"></i>
                        <span>Deze transcriptie is automatisch gegenereerd en kan onnauwkeurigheden bevatten.</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Instellingen Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-hh-darker rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Instellingen</h3>
                <button id="closeSettings" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="space-y-4">
                    <div>
                        <label for="apiKey" class="block text-sm font-medium mb-1">API Key</label>
                        <input type="password" id="apiKey" placeholder="Vul je API key in" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-hh-accent">
                        <p class="text-xs text-gray-400 mt-1">Vereist voor authenticatie</p>
                    </div>
                    
                    <div class="pt-2 border-t border-gray-700">
                        <label for="whisperApiUrl" class="block text-sm font-medium mb-1">Whisper API URL</label>
                        <input type="text" id="whisperApiUrl" placeholder="https://jouw-domein.nl:5000" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-hh-accent">
                    </div>
                    
                    <div>
                        <label for="n8nWebhookUrl" class="block text-sm font-medium mb-1">n8n Webhook URL (optioneel)</label>
                        <input type="text" id="n8nWebhookUrl" placeholder="https://jouw-n8n-instance.com/webhook/..." 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-hh-accent">
                        <p class="text-xs text-gray-400 mt-1">Laat leeg om de ingebouwde transcriptie te gebruiken</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelSettings" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-500">
                    Annuleren
                </button>
                <button id="saveSettings" class="px-4 py-2 bg-hh-accent text-white rounded-md hover:bg-yellow-600">
                    Opslaan
                </button>
            </div>
        </div>
    </div>

    <footer class="bg-hh-dark mt-8">
        <div class="container mx-auto py-6 px-4 text-center">
            <div class="flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 50" class="h-6 w-auto">
                    <text x="0" y="30" font-family="Arial, sans-serif" font-size="24" font-weight="bold" fill="#b3b441">WHISPER</text>
                </svg>
                <span class="text-white text-sm">API v1.0</span>
            </div>
            <p class="text-gray-400 text-sm mt-2">Audio transcriptie met Whisper AI</p>
        </div>
        <div class="bg-hh-darker">
            <div class="container mx-auto px-4 py-3">
                <div class="grid grid-cols-1 md:grid-cols-2 items-center text-center gap-4">
                    <div class="text-xs text-gray-400 md:text-left">
                        &copy; HEIDENHAIN 2025
                    </div>
                    <div class="flex justify-center md:justify-end space-x-4">
                        <a href="#" class="text-white hover:text-gray-300">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                        </a>
                        <a href="#" class="text-white hover:text-gray-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Font Awesome voor icoontjes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script>
        // Configuratie
        const CONFIG = {
            whisperApiUrl: localStorage.getItem('whisperApiUrl') || 'http://localhost:5000',
            n8nWebhookUrl: localStorage.getItem('n8nWebhookUrl') || '',
            useN8N: false
        };
        
        // API configuration - gebruik de geconfigureerde URL of standaard localhost:5000
        let API_BASE_URL = CONFIG.whisperApiUrl;
        let API_KEY = ''; // Wordt ingevuld bij het laden van de pagina
        
        // Voeg een slash toe aan het einde van de URL als die er nog niet is
        if (API_BASE_URL && !API_BASE_URL.endsWith('/')) {
            API_BASE_URL = API_BASE_URL + '/';
        }

        // DOM elementen
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const cancelSettings = document.getElementById('cancelSettings');
        const saveSettings = document.getElementById('saveSettings');
        const n8nWebhookInput = document.getElementById('n8nWebhookUrl');
        const whisperApiUrlInput = document.getElementById('whisperApiUrl');
        const apiKeyInput = document.getElementById('apiKey');

        // Event listeners voor instellingen
        settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        closeSettings.addEventListener('click', () => settingsModal.classList.add('hidden'));
        cancelSettings.addEventListener('click', () => settingsModal.classList.add('hidden'));
        
        // Instellingen opslaan
        saveSettings.addEventListener('click', () => {
            try {
                const whisperUrl = whisperApiUrlInput.value.trim();
                const n8nUrl = n8nWebhookInput.value.trim();
                const apiKey = apiKeyInput.value.trim();
                
                console.log('Saving settings:', { whisperUrl, n8nUrl, apiKey: apiKey ? '***' : 'not set' });
                
                // Valideer en sla de Whisper API URL op
                if (whisperUrl) {
                    try {
                        // Eenvoudige URL validatie
                        new URL(whisperUrl);
                    } catch (e) {
                        showError('Ongeldige API URL. Voer een geldige URL in (bijv. http://localhost:5000)');
                        return;
                    }
                } else {
                    showError('Voer een geldige Whisper API URL in');
                    return;
                }
                
                // Valideer API key
                if (!apiKey) {
                    showError('Voer een geldige API key in');
                    return;
                }
                
                // Sla alle instellingen op in localStorage
                localStorage.setItem('whisperApiUrl', whisperUrl);
                localStorage.setItem('n8nWebhookUrl', n8nUrl);
                localStorage.setItem('apiKey', apiKey);
                
                // Update configuratie
                API_BASE_URL = whisperUrl.endsWith('/') ? whisperUrl.slice(0, -1) : whisperUrl;
                API_KEY = apiKey;
                CONFIG.whisperApiUrl = API_BASE_URL;
                CONFIG.n8nWebhookUrl = n8nUrl;
                CONFIG.useN8N = !!n8nUrl;
                
                console.log('Settings saved:', { 
                    API_BASE_URL, 
                    useN8N: CONFIG.useN8N,
                    hasApiKey: !!API_KEY 
                });
                
                // Toon bevestiging
                showStatus('Instellingen opgeslagen', 'success');
                
                // Sluit het instellingenvenster na een korte vertraging
                setTimeout(() => {
                    settingsModal.classList.add('hidden');
                }, 1000);
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showError('Er is een fout opgetreden bij het opslaan van de instellingen');
            }
        });

        // Laad opgeslagen instellingen bij het opstarten
        function loadSettings() {
            try {
                const savedWhisperUrl = localStorage.getItem('whisperApiUrl');
                const savedN8nUrl = localStorage.getItem('n8nWebhookUrl');
                const savedApiKey = localStorage.getItem('apiKey');
                
                console.log('Loading settings from localStorage:', { savedWhisperUrl, savedN8nUrl, savedApiKey: savedApiKey ? '***' : 'not set' });
                
                // Zorg ervoor dat we altijd een standaardwaarde hebben
                API_BASE_URL = 'http://localhost:5000';
                
                if (savedWhisperUrl && savedWhisperUrl.trim() !== '') {
                    whisperApiUrlInput.value = savedWhisperUrl;
                    CONFIG.whisperApiUrl = savedWhisperUrl;
                    API_BASE_URL = savedWhisperUrl;
                } else {
                    // Standaardwaarde voor development
                    whisperApiUrlInput.value = API_BASE_URL;
                    CONFIG.whisperApiUrl = API_BASE_URL;
                }
                
                if (savedN8nUrl && savedN8nUrl.trim() !== '') {
                    n8nWebhookInput.value = savedN8nUrl;
                    CONFIG.n8nWebhookUrl = savedN8nUrl;
                    CONFIG.useN8N = true;
                } else {
                    CONFIG.useN8N = false;
                }
                
                if (savedApiKey && savedApiKey.trim() !== '') {
                    apiKeyInput.value = savedApiKey;
                    API_KEY = savedApiKey;
                } else {
                    // Vraag alleen om API key als deze echt nodig is
                    const apiKey = prompt('Voer de API key in:');
                    if (apiKey && apiKey.trim() !== '') {
                        localStorage.setItem('apiKey', apiKey);
                        apiKeyInput.value = apiKey;
                        API_KEY = apiKey;
                    }
                }
                
                console.log('Settings loaded:', { 
                    API_BASE_URL, 
                    useN8N: CONFIG.useN8N,
                    hasApiKey: !!API_KEY 
                });
                
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Bestand verzenden naar n8n
        async function sendToN8N(file) {
            if (!CONFIG.useN8N || !CONFIG.n8nWebhookUrl) {
                throw new Error('n8n webhook URL is niet geconfigureerd');
            }

            console.log('Sending to n8n webhook:', CONFIG.n8nWebhookUrl);
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('language', document.getElementById('language').value);
            
            // Voeg API key toe als deze beschikbaar is
            if (API_KEY) {
                formData.append('api_key', API_KEY);
            }

            try {
                const response = await fetch(CONFIG.n8nWebhookUrl, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('n8n response status:', response.status);
                
                if (!response.ok) {
                    let errorMsg = `Fout bij verzenden naar n8n: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.detail || errorData.message || errorMsg;
                    } catch (e) {
                        console.error('Error parsing n8n error response:', e);
                    }
                    throw new Error(errorMsg);
                }

                return await response.json();
            } catch (error) {
                console.error('Error sending to n8n:', error);
                throw new Error(`Fout bij verzenden naar n8n: ${error.message}`);
            }
        }

        // Haal de API configuratie op
        async function loadApiConfig() {
            try {
                console.log('Loading API config from:', API_BASE_URL);
                const response = await fetch(`${API_BASE_URL}/api/config`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const config = await response.json();
                console.log('API config loaded:', config);
                
                return true;
            } catch (error) {
                console.error('Fout bij ophalen API configuratie:', error);
                // Toon alleen een melding als de API key nog niet is ingesteld
                if (!API_KEY) {
                    alert('Kan geen verbinding maken met de server. Controleer de URL en probeer het opnieuw.');
                }
                return false;
            }
        }

        // Initialize the application when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSettings();
            
            // Controleer of er een API-sleutel is ingesteld
            if (!API_KEY) {
                // Als er geen API-sleutel is, vraag deze dan aan de gebruiker
                const apiKey = prompt('Voer de API-sleutel in (gebruik "test123" voor testen):');
                if (apiKey && apiKey.trim() !== '') {
                    localStorage.setItem('apiKey', apiKey);
                    API_KEY = apiKey;
                    console.log('API key set from prompt');
                    // Update de UI na het instellen van de API-sleutel
                    updateUI();
                }
            }
            
            await loadApiConfig();
            
            // Initialize UI elements
            const copyBtn = document.getElementById('copyBtn');
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('audioFile');
            const fileName = document.getElementById('fileName');
            const uploadForm = document.getElementById('uploadForm');
            
            // Initialize copy to clipboard functionality
            if (copyBtn) {
                copyBtn.addEventListener('click', async () => {
                    const transcript = document.getElementById('transcript').textContent;
                    try {
                        await navigator.clipboard.writeText(transcript);
                        
                        // Update button text and icon temporarily
                        const originalHTML = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check mr-1.5"></i> Gekopieerd!';
                        copyBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                        copyBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        
                        // Reset button after 2 seconds
                        setTimeout(() => {
                            copyBtn.innerHTML = originalHTML;
                            copyBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                            copyBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        showError('Kon tekst niet kopiëren naar klembord');
                    }
                });
            }
            
            // Handle file selection via button
            if (dropZone && fileInput) {
                dropZone.addEventListener('click', () => fileInput.click());
                
                // Handle file input change
                fileInput.addEventListener('change', (e) => {
                    if (fileInput.files.length > 0) {
                        updateFileName(fileInput.files[0].name);
                    }
                });
                
                // Handle drag and drop
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });
                
                // Highlight drop zone when item is dragged over it
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, unhighlight, false);
                });
                
                // Handle dropped files
                dropZone.addEventListener('drop', handleDrop, false);
            }
            
            // Handle form submission
            if (uploadForm) {
                uploadForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    if (!fileInput || fileInput.files.length === 0) {
                        showError('Selecteer eerst een audiobestand');
                        return;
                    }
                    
                    const file = fileInput.files[0];
                    const language = document.getElementById('language').value;
                    
                    // Reset UI
                    showStatus('Bezig met verwerken...', 'uploading');
                    document.getElementById('result').classList.add('hidden');
                    document.getElementById('error').classList.add('hidden');
                    
                    try {
                        // Controleer of er een API key is
                        if (!API_KEY) {
                            throw new Error('Geen API key ingesteld. Voer een geldige API key in via de instellingen.');
                        }
                        
                        console.log('Starting file upload with config:', {
                            API_BASE_URL,
                            language,
                            fileSize: file.size,
                            fileName: file.name,
                            useN8N: CONFIG.useN8N
                        });
                        
                        let result;
                        
                        if (CONFIG.useN8N) {
                            // Verstuur naar n8n webhook
                            showStatus('Bestand wordt naar n8n gestuurd...', 'processing');
                            result = await sendToN8N(file);
                            showResult(result.transcript || 'Geen transcriptie ontvangen');
                        } else {
                            // Originele uploadlogica naar lokale API
                            showStatus('Bestand wordt verwerkt...', 'processing');
                            
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('language', language);
                            
                            console.log('Sending request to:', `${API_BASE_URL}/api/transcribe`);
                            
                            // Verwijder de Content-Type header zodat de browser de juiste boundary kan instellen
                            const response = await fetch(`${API_BASE_URL}/api/transcribe`, {
                                method: 'POST',
                                headers: {
                                    'x-admin-api-key': API_KEY,
                                    'Accept': 'application/json'
                                },
                                body: formData
                            });
                            
                            console.log('Upload response status:', response.status);
                            
                            if (!response.ok) {
                                let errorDetail = 'Er is een fout opgetreden bij het uploaden';
                                try {
                                    const errorData = await response.json();
                                    errorDetail = errorData.detail || errorData.message || errorDetail;
                                } catch (e) {
                                    console.error('Error parsing error response:', e);
                                }
                                throw new Error(errorDetail);
                            }
                            
                            const data = await response.json();
                            console.log('Upload response data:', data);
                            
                            if (data.status === 'processing') {
                                // Poll for status
                                checkTranscriptionStatus(data.task_id);
                                return;
                            } else if (data.status === 'completed') {
                                result = data.text;
                            } else {
                                throw new Error('Onverwachte status ontvangen: ' + (data.status || 'onbekend'));
                            }
                            
                            showResult(result);
                        }
                    } catch (error) {
                        console.error('Upload fout:', error);
                        showError(error.message || 'Er is een fout opgetreden');
                    }
                });
            }
        });
        
        // Helper functions for drag and drop
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight() {
            const dropZone = document.getElementById('dropZone');
            if (dropZone) {
                dropZone.classList.add('border-blue-500', 'bg-gray-800');
            }
        }
        
        function unhighlight() {
            const dropZone = document.getElementById('dropZone');
            if (dropZone) {
                dropZone.classList.remove('border-blue-500', 'bg-gray-800');
            }
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            const fileInput = document.getElementById('audioFile');
            
            if (files.length > 0 && fileInput) {
                fileInput.files = files;
                updateFileName(files[0].name);
            }
        }
        
        function updateFileName(name) {
            const fileName = document.getElementById('fileName');
            if (fileName) {
                fileName.textContent = name;
                fileName.classList.remove('text-gray-400');
                fileName.classList.add('text-white');
            }
        }

        // Load example file
        function loadExample(exampleId) {
            // Reset any previous state
            document.getElementById('result').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            
            // Show loading state
            showStatus('Voorbeeld wordt geladen...', 'uploading');
            
            // Example file URLs (replace with actual example files)
            const examples = {
                example1: 'https://example.com/path/to/example1.mp3',
                example2: 'https://example.com/path/to/example2.mp3'
            };
            
            // Simulate file selection (in a real app, you would fetch the example file)
            setTimeout(() => {
                const exampleName = exampleId === 'example1' ? 'nederlands-gesprek.mp3' : 'engelse-presentatie.mp3';
                document.getElementById('fileName').textContent = `Voorbeeld: ${exampleName}`;
                
                // Simulate processing
                setTimeout(() => {
                    showStatus('Voorbeeld wordt verwerkt...', 'processing');
                    
                    // Simulate completion after a delay
                    setTimeout(() => {
                        const exampleText = exampleId === 'example1' 
                            ? "Hallo, dit is een voorbeeld van een Nederlands gesprek.\n\nHet is bedoeld om te laten zien hoe de transcriptie eruit zal zien."
                            : "Hello, this is an example of an English presentation.\n\nIt's designed to show you how the transcription will look like.";
                        
                        showStatus('Transcriptie voltooid!', 'success');
                        showResult(exampleText);
                    }, 2000);
                }, 1000);
            }, 500);
        }
        // API configuration - wordt nu ingesteld in de CONFIG en kan worden aangepast via instellingen
        // Zorg ervoor dat API_BASE_URL geen trailing slash heeft
        if (API_BASE_URL.endsWith('/')) {
            API_BASE_URL = API_BASE_URL.slice(0, -1);
        }
        
        // DOM elements
        const form = document.getElementById('uploadForm');
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const progressBar = document.getElementById('progress');
        const result = document.getElementById('result');
        const transcript = document.getElementById('transcript');
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');
        const downloadBtn = document.getElementById('downloadBtn');

        // Handle form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('audioFile');
            const file = fileInput.files[0];
            const language = document.getElementById('language').value;
            
            if (!file) {
                showError('Selecteer eerst een audiobestand');
                return;
            }

            // Reset UI
            showStatus('Bezig met verwerken...', 'uploading');
            document.getElementById('result').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            
            try {
                let result;
                
                if (CONFIG.useN8N) {
                    // Verstuur naar n8n webhook
                    showStatus('Bestand wordt naar n8n gestuurd...', 'processing');
                    result = await sendToN8N(file);
                    showResult(result.transcript || 'Geen transcriptie ontvangen');
                } else {
                    // Originele uploadlogica naar lokale API
                    showStatus('Bestand wordt verwerkt...', 'processing');
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const apiUrl = `${API_BASE_URL}/api/transcribe?language=${language}`;
                    console.log('API URL:', apiUrl);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'X-Admin-API-Key': API_KEY
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Er is een fout opgetreden bij het uploaden');
                    }
                    
                    const data = await response.json();
                    
                    if (data.status === 'processing') {
                        // Poll for status
                        checkTranscriptionStatus(data.task_id);
                        return;
                    } else if (data.status === 'completed') {
                        result = data.text;
                    } else {
                        throw new Error('Onverwachte status ontvangen');
                    }
                    
                    showResult(result);
                }
            } catch (error) {
                console.error('Upload fout:', error);
                showError(error.message || 'Er is een fout opgetreden');
            }
        });
        
        // Check transcription status for async processing
        async function checkTranscriptionStatus(taskId, attempt = 1) {
            const MAX_ATTEMPTS = 30;
            const RETRY_DELAY = 2000; // 2 seconds
            
            if (attempt > MAX_ATTEMPTS) {
                throw new Error('Time-out: De verwerking duurt langer dan verwacht. Probeer het later opnieuw.');
            }
            
            try {
                // Update status with attempt counter
                showStatus(`Bestand wordt verwerkt (poging ${attempt}/${MAX_ATTEMPTS})...`, 'processing');
                
                const statusUrl = `${API_BASE_URL}/api/status/${taskId}`;
                console.log('Status URL:', statusUrl);
                const response = await fetch(statusUrl, {
                    headers: {
                        'X-Admin-API-Key': API_KEY,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Kan de status niet ophalen van de server');
                }
                
                const result = await response.json();
                
                if (result.status === 'completed') {
                    // Update progress to 100%
                    document.getElementById('progress').style.width = '100%';
                    showStatus('Transcriptie voltooid!', 'success');
                    showResult(result.transcription || 'Geen tekst gevonden');
                } else if (result.status === 'processing') {
                    if (attempt >= MAX_ATTEMPTS) {
                        throw new Error('Het duurt te lang om het bestand te verwerken. Probeer het later opnieuw.');
                    }
                    
                    // Update progress (start at 70% and move towards 95% based on attempts)
                    const progress = 70 + Math.min(25, (attempt / MAX_ATTEMPTS) * 25);
                    document.getElementById('progress').style.width = `${progress}%`;
                    
                    // Poll again after a delay
                    setTimeout(() => checkTranscriptionStatus(taskId, attempt + 1), RETRY_DELAY);
                } else if (result.status === 'failed') {
                    throw new Error('Transcriptie mislukt: ' + (result.error || 'Onbekende fout'));
                } else {
                    throw new Error('Onverwachte status: ' + result.status);
                }
                
            } catch (error) {
                console.error('Status check error:', error);
                
                if (attempt < MAX_ATTEMPTS) {
                    // Retry on temporary errors
                    console.log(`Retrying... (${attempt}/${MAX_ATTEMPTS})`);
                    setTimeout(() => checkTranscriptionStatus(taskId, attempt + 1), RETRY_DELAY);
                } else {
                    showError(`Fout: ${error.message}`);
                }
            }
        }
        
        // Show the transcription result
        function showResult(text) {
            const resultElement = document.getElementById('result');
            const transcriptElement = document.getElementById('transcript');
            const downloadBtn = document.getElementById('downloadBtn');
            
            // Format the text with line breaks for better readability
            const formattedText = text
                .replace(/\n\s*\n/g, '\n\n') // Preserve double line breaks
                .trim();
            
            // Display the formatted text with proper HTML line breaks
            transcriptElement.innerHTML = formattedText.replace(/\n/g, '<br>');
            
            // Set up download button
            if (formattedText) {
                const blob = new Blob([formattedText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                // Update download button
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `transcript-${new Date().toISOString().slice(0, 10)}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };
                
                downloadBtn.classList.remove('hidden');
            } else {
                downloadBtn.classList.add('hidden');
            }
            
            // Show the result container with a nice animation
            resultElement.classList.remove('hidden');
            resultElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Helper function to show status messages
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            const statusTextElement = document.getElementById('statusText');
            const progressBar = document.getElementById('progress');
            
            // Update status text
            statusTextElement.textContent = message;
            
            // Show/hide status based on type
            if (type === 'error') {
                statusElement.classList.add('hidden');
                showError(message);
                return;
            } else if (type === 'success') {
                // For success, we'll hide the status after a short delay
                setTimeout(() => {
                    statusElement.classList.add('hidden');
                }, 2000);
            } else {
                // For info/processing, make sure it's visible
                statusElement.classList.remove('hidden');
            }
            
            // Update progress bar if needed
            if (type === 'processing') {
                progressBar.style.width = '70%';
            } else if (type === 'success') {
                progressBar.style.width = '100%';
            }
            
            // Hide error if showing status
            document.getElementById('error').classList.add('hidden');
        }
        
        // Helper function to show error messages
        function showError(message) {
            const errorElement = document.getElementById('error');
            const errorMessageElement = document.getElementById('errorMessage');
            
            // Update error message
            errorMessageElement.textContent = message;
            
            // Show error and hide status
            errorElement.classList.remove('hidden');
            document.getElementById('status').classList.add('hidden');
            
            // Log to console for debugging
            console.error('Error:', message);
        }
        

    </script>
    
</body>
</html>